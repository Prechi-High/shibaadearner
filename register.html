<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js?58"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-orange: #ff6b35;
            --yellow-accent: #ffd23f;
            --text-dark: #1a1a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, var(--primary-orange) 0%, var(--yellow-accent) 90%);
            min-height: 100vh;
            font-family: "Poppins", sans-serif;
            color: var(--text-dark);
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            margin-top: 70px;
        }

        .progress-indicator {
            display: flex;
            gap: 8px;
        }

        .progress-dot {
            width: 8px;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background-color: white;
            width: 40px;
        }

        .skip-btn {
            background-color: var(--yellow-accent);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            font-style:italic;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }

        .slider-container {
            flex: 1;
            overflow: hidden;
        }

        .slides {
            display: flex;
            transition: transform 0.3s ease-out;
            height: 100%;
        }

        .slide {
            flex: 0 0 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 20px;
        }

        .main-title {
            font-size: 2rem;
            font-weight: 600;
            line-height: 1.1;
            text-align: center;
            margin-bottom: 20px;
        }

        .subtitle {
            font-size: 1rem;
            font-weight: 400;
            font-style:italic;
            text-align: center;
            margin-bottom: 40px;
            opacity: 0.8;
        }

        .illustration {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 310px;
            height: 310px;
            margin: 20px auto;
        }

        .illustration-football {
            background-image: url('img/football.png');
            width: 310px;
            height: 310px;
        }

        .illustration-box {
            background-image: url('img/box.png');
            width: 310px;
            height: 310px;
        }

        .illustration-net {
            background-image: url('img/net.png');
            width: 310px;
            height: 310px;
        }

        .bottom-section {
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .btn-nav, .continue-btn {
            background-color: var(--primary-orange);
            color: white;
            border: none;
            padding: 16px 0;
            border-radius: 50px;
            font-weight: 600;
            font-size: 18px;
            width: 100%;
            max-width: 300px;
            cursor: pointer;
            display: none;
        }

        .btn-nav.active, .continue-btn.active {
            display: block;
        }

        .swal2-popup {
            border-radius: 20px !important;
            font-family: "Poppins", sans-serif !important;
        }

        .redirect-btn {
            background-color: var(--yellow-accent) !important;
            color: var(--text-dark) !important;
            border: 2px solid var(--primary-orange) !important;
            border-radius: 25px !important;
            padding: 12px 24px !important;
            margin: 8px !important;
            font-weight: 600 !important;
        }

        .get-started-btn {
            background-color: var(--primary-orange) !important;
            color: white !important;
            border-radius: 25px !important;
            padding: 14px 32px !important;
            margin-top: 20px !important;
            font-weight: 600 !important;
        }

        .error-message {
            background-color: #dc3545 !important;
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 10px !important;
            margin-bottom: 15px !important;
            font-size: 14px !important;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="progress-indicator">
                <div class="progress-dot active" data-slide="0"></div>
                <div class="progress-dot" data-slide="1"></div>
                <div class="progress-dot" data-slide="2"></div>
            </div>
            <button class="skip-btn" onclick="showRedirectPopup()">Skip</button>
        </div>

        <div class="slider-container">
            <div class="slides">
                <div class="slide">
                    <h1 class="main-title">Scratch cards that win real prizes</h1>
                    <p class="subtitle">Welcome to a new way to play and earn. Every scratch brings surprises, rewards, and more chances to win.</p>
                    <div class="illustration illustration-football"></div>
                </div>
                <div class="slide">
                    <h1 class="main-title">Lucky boxes that unlock rewards</h1>
                    <p class="subtitle">Unlock player cards, complete tasks and discover exciting rewards as you play!</p>
                    <div class="illustration illustration-box"></div>
                </div>
                <div class="slide">
                    <h1 class="main-title">Let's Get Started</h1>
                    <p class="subtitle">You're all set to play, earn and win. Tap continue and dive into WintroPlay!</p>
                    <div class="illustration illustration-net"></div>
                </div>
            </div>
        </div>

        <div class="bottom-section">
            <button class="btn-nav active" id="nextBtn1" onclick="goToNextSlide()">Next</button>
            <button class="btn-nav" id="nextBtn2" onclick="goToNextSlide()">Next</button>
            <button class="continue-btn" id="continueBtn" onclick="showRedirectPopup()">Continue</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentIndex = 0;
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        const slider = document.querySelector('.slides');
        const slides = document.querySelectorAll('.slide');
        const progressDots = document.querySelectorAll('.progress-dot');
        const nextBtn1 = document.getElementById('nextBtn1');
        const nextBtn2 = document.getElementById('nextBtn2');
        const continueBtn = document.getElementById('continueBtn');
        const tg = window.Telegram.WebApp;

        const redirectLinks = [
            { text: 'Update channel', url: 'https://t.me/Lumora_Community' }
        ];

        function updateSlider() {
            slider.style.transform = `translateX(-${currentIndex * 100}%)`;
            progressDots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentIndex);
            });
            nextBtn1.classList.toggle('active', currentIndex === 0);
            nextBtn2.classList.toggle('active', currentIndex === 1);
            continueBtn.classList.toggle('active', currentIndex === 2);
        }

        function goToSlide(index) {
            if (index >= 0 && index < slides.length) {
                currentIndex = index;
                slider.style.transition = 'transform 0.3s ease-out';
                updateSlider();
            }
        }

        function goToNextSlide() {
            goToSlide(currentIndex + 1);
        }

        slider.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            currentX = startX;
            isDragging = true;
            slider.style.transition = 'none';
        });

        slider.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = currentX - startX;
            const translateX = -currentIndex * 100 + (diff / slider.offsetWidth) * 100;
            slider.style.transform = `translateX(${translateX}%)`;
        });

        slider.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            const diff = currentX - startX;
            if (Math.abs(diff) > 50) {
                if (diff < 0 && currentIndex < slides.length - 1) {
                    currentIndex++;
                } else if (diff > 0 && currentIndex > 0) {
                    currentIndex--;
                }
            }
            slider.style.transition = 'transform 0.3s ease-out';
            updateSlider();
        });

        function showRedirectPopup() {
            let buttonsHtml = '<div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">';
            redirectLinks.forEach((link) => {
                buttonsHtml += `<button class="redirect-btn" onclick="window.open('${link.url}', '_blank')">${link.text}</button>`;
            });
            buttonsHtml += '</div>';
            buttonsHtml += '<div id="error-message" class="error-message"></div>';
            buttonsHtml += '<button id="get-started-btn" class="get-started-btn" onclick="handleGetStarted()">Get Started</button>';

            Swal.fire({
                title: 'Before You Continue',
                html: buttonsHtml,
                showConfirmButton: false,
                allowOutsideClick: false,
                allowEscapeKey: false,
                customClass: { popup: 'custom-popup' }
            });
        }

        async function handleGetStarted() {
            const getStartedBtn = document.getElementById('get-started-btn');
            const errorMessage = document.getElementById('error-message');

            errorMessage.style.display = 'none';
            getStartedBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            getStartedBtn.disabled = true;

            try {
                const result = await registerUser();
                if (result.success) {
                    window.location.href = 'index.html';
                } else {
                    errorMessage.textContent = result.message || 'Registration failed. Please try again.';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                errorMessage.textContent = 'Network error. Please try again later.';
                errorMessage.style.display = 'block';
            } finally {
                getStartedBtn.innerHTML = 'Get Started';
                getStartedBtn.disabled = false;
            }
        }

        async function registerUser() {
            let ipAddress = '103.105.45.78';
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                ipAddress = ipData.ip;
            } catch (error) {
                console.error('Failed to fetch IP address:', error);
            }

            const initData = tg.initData;
            const inviterId = tg.initDataUnsafe?.start_param || '';
            const data = {
                init_data: initData,
                ip_address: ipAddress,
                inviter_id: inviterId
            };

            const response = await fetch('api/register.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            return { success: result.ok, message: result.message };
        }

        updateSlider();
    </script>
</body>
</html>
